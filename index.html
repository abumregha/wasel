<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Expert | مولد الفواتير</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkludm9pY2UgRXhwZXJ0IiwKICAic2hvcnRfbmFtZSI6ICJJbnZvaWNlIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmOGZhZmMiLAogICJ0aGVtZV9jb2xvciI6ICIjMzM0MTU1Igp9">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* الألوان الهادئة الجديدة */
        :root { 
            --primary: #334155; /* Slate 700 */
            --accent: #64748b; 
            --bg-light: #f8fafc;
            --border: #e2e8f0;
        }
        
        * { box-sizing: border-box; font-family: 'Noto Sans Arabic', sans-serif; }
        body { background: #f1f5f9; margin: 0; padding: 20px; color: #334155; transition: all 0.3s; }
        
        .app-container { 
            max-width: 850px; margin: 0 auto; background: white; padding: 50px; 
            border-radius: 4px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); position: relative; 
        }
        
        /* Toolbar */
        .toolbar { 
            display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; 
            align-items: center; justify-content: space-between; max-width: 850px; margin-left: auto; margin-right: auto;
        }
        .theme-dots { display: flex; gap: 10px; background: white; padding: 8px 15px; border-radius: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .dot { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .dot:hover { transform: scale(1.2); }
        .dot.active { border-color: #000; }
        
        /* Header Section */
        .invoice-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; }
        .company-info input { 
            font-size: 28px; font-weight: 600; border: none; outline: none; 
            width: 100%; color: var(--primary); background: transparent;
        }
        .logo-box { 
            width: 130px; height: 130px; border: 1px dashed var(--border); 
            display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; border-radius: 8px;
        }
        .logo-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        /* Client Grid */
        .client-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px; border-top: 1px solid var(--border); padding-top: 25px; }
        .field-group { display: flex; flex-direction: column; }
        .field-group label { font-size: 11px; font-weight: 600; color: #94a3b8; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.5px; }
        input[type="text"], input[type="number"], input[type="date"] { 
            padding: 10px; border: 1px solid var(--border); border-radius: 4px; outline: none; font-size: 14px; color: #475569;
        }
        input:focus { border-color: var(--primary); }

        /* Table Style */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: var(--bg-light); color: var(--primary); padding: 12px; text-align: start; font-size: 13px; border-bottom: 2px solid var(--primary); }
        td { border-bottom: 1px solid var(--border); padding: 12px; }
        .col-total { font-weight: 600; color: var(--primary); }

        /* Totals */
        .summary { margin-top: 40px; display: flex; flex-direction: column; align-items: flex-end; gap: 12px; }
        .total-row { display: flex; justify-content: space-between; width: 250px; font-size: 15px; }
        .grand-total { 
            font-size: 20px; font-weight: 600; color: white; background: var(--primary); 
            padding: 10px 15px; border-radius: 4px; margin-top: 10px; 
        }

        /* Buttons */
        .btn { padding: 8px 18px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 14px; }
        .btn-add { background: var(--bg-light); color: var(--primary); border: 1px solid var(--border); margin-top: 15px; }
        .btn-add:hover { background: var(--border); }
        .btn-print { background: var(--primary); color: white; }
        .btn-lang { background: white; color: var(--primary); border: 1px solid var(--border); }

        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .app-container { box-shadow: none; margin: 0; width: 100%; padding: 20px; }
            .grand-total { color: var(--primary) !important; background: transparent !important; border-top: 2px solid var(--primary); padding: 10px 0; }
        }

        /* RTL/LTR Dynamic Adjustments */
        [dir="ltr"] .invoice-header, [dir="ltr"] .client-grid { text-align: left; }
    </style>
</head>
<body>

<div class="toolbar no-print">
    <div class="theme-dots">
        <div class="dot active" style="background: #334155;" onclick="setTheme('#334155', this)"></div>
        <div class="dot" style="background: #475569;" onclick="setTheme('#475569', this)"></div>
        <div class="dot" style="background: #3e4e41;" onclick="setTheme('#3e4e41', this)"></div>
        <div class="dot" style="background: #634242;" onclick="setTheme('#634242', this)"></div>
        <div class="dot" style="background: #1e293b;" onclick="setTheme('#1e293b', this)"></div>
        <div class="dot" style="background: #57534e;" onclick="setTheme('#57534e', this)"></div>
    </div>
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-lang" onclick="toggleLang()" id="langBtn">English</button>
        <button class="btn btn-print" onclick="window.print()"><span id="txt-print">طباعة PDF</span></button>
    </div>
</div>

<div class="app-container">
    <div class="invoice-header">
        <div class="company-info">
            <input type="text" id="compName" value="اسم شركتك هنا" placeholder="Company Name">
            <p id="invIdDisplay" style="margin: 8px 0; color: #94a3b8; font-size: 13px; letter-spacing: 1px;"></p>
            <div style="margin-top: 15px;">
                <input type="text" id="invType" value="فاتورة ضريبية" style="font-weight: 600; color: var(--accent); border:none; padding:0; width: auto;">
            </div>
        </div>
        <div class="logo-box" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" hidden accept="image/*" onchange="previewLogo(this)">
            <img id="logoImg" src="" style="display: none;">
            <span id="logoPlaceholder" class="no-print" style="font-size: 12px; color: #94a3b8;">+ شعار الشركة</span>
        </div>
    </div>

    <div class="client-grid">
        <div class="field-group">
            <label id="lbl-client">العميل المُستهدف</label>
            <input type="text" placeholder="اسم العميل / الشركة" id="clientName">
            <input type="text" placeholder="العنوان، رقم الهاتف" style="margin-top: 8px;" id="clientContact">
        </div>
        <div class="field-group">
            <label id="lbl-date">تاريخ الإصدار</label>
            <input type="date" id="invDate">
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th id="th-item" style="width: 50%;">الوصف</th>
                <th id="th-price">السعر</th>
                <th id="th-qty">الكمية</th>
                <th id="th-total">الإجمالي</th>
                <th class="no-print" style="width: 40px;"></th>
            </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
    </table>
    <button class="btn btn-add no-print" onclick="addRow()" id="btn-addRow">+ إضافة عنصر جديد</button>

    <div class="summary">
        <div class="total-row">
            <span id="lbl-subtotal">إجمالي البنود:</span>
            <span id="subTotal">0.00</span>
        </div>
        <div class="total-row" style="color: #94a3b8;">
            <span id="lbl-paid">المبلغ المدفوع:</span>
            <input type="number" id="paidAmount" value="0" oninput="calculateTotals()" style="width: 90px; border:none; border-bottom:1px solid #eee; text-align: center; color: inherit;">
        </div>
        <div class="total-row grand-total">
            <span id="lbl-grand">صافي المستحق:</span>
            <span id="grandTotal">0.00</span>
        </div>
    </div>

    <div style="margin-top: 60px; text-align: center; border-top: 1px solid var(--border); padding-top: 20px;">
        <p style="font-size: 13px; color: #94a3b8;" id="footer-msg">نشكركم على ثقتكم بنا</p>
        <div id="barcodeDisplay" style="font-family: monospace; font-size: 11px; color: #cbd5e1; margin-top: 10px;"></div>
    </div>
</div>

<script>
    let currentLang = 'ar';
    const translations = {
        ar: { print: "طباعة PDF", item: "الوصف", price: "السعر", qty: "الكمية", total: "الإجمالي", add: "+ إضافة عنصر جديد", client: "العميل المُستهدف", date: "تاريخ الإصدار", sub: "إجمالي البنود:", paid: "المبلغ المدفوع:", grand: "صافي المستحق:", footer: "نشكركم على ثقتكم بنا" },
        en: { print: "Print Invoice", item: "Description", price: "Price", qty: "Quantity", total: "Total", add: "+ Add New Item", client: "Bill To", date: "Date of Issue", sub: "Subtotal:", paid: "Amount Paid:", grand: "Amount Due:", footer: "Thank you for your business" }
    };

    window.onload = () => {
        generateID();
        document.getElementById('invDate').valueAsDate = new Date();
        addRow();
        loadSavedData();
        
        // PWA Service Worker
        if ('serviceWorker' in navigator) {
            const sw = `const cacheName='inv-v2'; self.addEventListener('install',e=>e.waitUntil(caches.open(cacheName).then(c=>c.add(location.href)))); self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));`;
            const blob = new Blob([sw], {type: 'text/javascript'});
            navigator.serviceWorker.register(URL.createObjectURL(blob));
        }
    };

    function generateID() {
        const date = new Date().toISOString().slice(0,10).replace(/-/g,'');
        const id = `INV-${date}-${Math.random().toString(36).substr(2, 4).toUpperCase()}`;
        document.getElementById('invIdDisplay').innerText = id;
        document.getElementById('barcodeDisplay').innerText = id;
    }

    function addRow() {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" style="border:none; width:100%;" placeholder="..."></td>
            <td><input type="number" class="item-price" value="0" oninput="calculateTotals()" style="border:none; width:80px;"></td>
            <td><input type="number" class="item-qty" value="1" oninput="calculateTotals()" style="border:none; width:60px;"></td>
            <td class="col-total">0.00</td>
            <td class="no-print"><button onclick="this.parentElement.parentElement.remove();calculateTotals()" style="color:#cbd5e1; border:none; background:none; cursor:pointer; font-size:18px;">&times;</button></td>
        `;
        document.getElementById('itemsBody').appendChild(tr);
    }

    function calculateTotals() {
        let sub = 0;
        document.querySelectorAll('#itemsBody tr').forEach(row => {
            const p = parseFloat(row.querySelector('.item-price').value) || 0;
            const q = parseFloat(row.querySelector('.item-qty').value) || 0;
            const t = p * q;
            row.querySelector('.col-total').innerText = t.toFixed(2);
            sub += t;
        });
        const paid = parseFloat(document.getElementById('paidAmount').value) || 0;
        document.getElementById('subTotal').innerText = sub.toFixed(2);
        document.getElementById('grandTotal').innerText = (sub - paid).toFixed(2);
        saveToLocal();
    }

    function setTheme(color, el) {
        document.documentElement.style.setProperty('--primary', color);
        document.querySelectorAll('.dot').forEach(d => d.classList.remove('active'));
        el.classList.add('active');
        localStorage.setItem('inv-theme-v2', color);
    }

    function toggleLang() {
        currentLang = currentLang === 'ar' ? 'en' : 'ar';
        const d = document.documentElement;
        d.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
        d.lang = currentLang;
        
        const t = translations[currentLang];
        document.getElementById('txt-print').innerText = t.print;
        document.getElementById('th-item').innerText = t.item;
        document.getElementById('th-price').innerText = t.price;
        document.getElementById('th-qty').innerText = t.qty;
        document.getElementById('th-total').innerText = t.total;
        document.getElementById('btn-addRow').innerText = t.add;
        document.getElementById('lbl-client').innerText = t.client;
        document.getElementById('lbl-date').innerText = t.date;
        document.getElementById('lbl-subtotal').innerText = t.sub;
        document.getElementById('lbl-paid').innerText = t.paid;
        document.getElementById('lbl-grand').innerText = t.grand;
        document.getElementById('footer-msg').innerText = t.footer;
        document.getElementById('langBtn').innerText = currentLang === 'ar' ? 'English' : 'عربي';
    }

    function previewLogo(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('logoImg').src = e.target.result;
                document.getElementById('logoImg').style.display = 'block';
                document.getElementById('logoPlaceholder').style.display = 'none';
                localStorage.setItem('inv-logo-v2', e.target.result);
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function saveToLocal() {
        const data = { compName: document.getElementById('compName').value };
        localStorage.setItem('inv-settings-v2', JSON.stringify(data));
    }

    function loadSavedData() {
        const settings = JSON.parse(localStorage.getItem('inv-settings-v2'));
        if (settings) document.getElementById('compName').value = settings.compName;
        
        const savedColor = localStorage.getItem('inv-theme-v2');
        if (savedColor) {
            document.documentElement.style.setProperty('--primary', savedColor);
            document.querySelectorAll('.dot').forEach(d => {
                if(d.style.backgroundColor.includes(savedColor)) d.classList.add('active');
                else d.classList.remove('active');
            });
        }
        
        const savedLogo = localStorage.getItem('inv-logo-v2');
        if (savedLogo) {
            document.getElementById('logoImg').src = savedLogo;
            document.getElementById('logoImg').style.display = 'block';
            document.getElementById('logoPlaceholder').style.display = 'none';
        }
    }
</script>
</body>
</html>